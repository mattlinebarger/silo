<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" 
    content="default-src 'self'; 
             script-src 'self' 'unsafe-inline'; 
             style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
             font-src https://fonts.gstatic.com; 
             img-src 'self' data: file:;" />

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Google Sans", -apple-system, BlinkMacSystemFont, sans-serif;
      background: #fafafa;
      color: #333;
      padding: 48px;
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      font-weight: 500;
      font-size: 32px;
      margin-bottom: 32px;
    }

    h2 {
      font-weight: 500;
      font-size: 20px;
      margin-bottom: 16px;
      margin-top: 32px;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .profile-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .profile-item {
      display: flex;
      align-items: center;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .profile-item:hover {
      background: #e8eaed;
    }

    .profile-item.active {
      background: #e3f2fd;
      border: 2px solid #1a73e8;
    }

    .profile-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-right: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      color: #5f6368;
      font-size: 48px;
      flex-shrink: 0;
      background: #f1f3f4;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .profile-avatar .material-symbols-outlined {
      font-size: 48px;
    }

    .profile-info {
      flex: 1;
    }

    .profile-name {
      font-weight: 500;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .profile-badge {
      display: inline-block;
      background: #1a73e8;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 8px;
    }

    .profile-actions {
      display: flex;
      gap: 8px;
    }

    .icon-button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .icon-button:hover {
      background: rgba(0,0,0,0.05);
    }

    .icon-button .material-symbols-outlined {
      font-size: 20px;
      color: #5f6368;
    }

    .button {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-family: "Google Sans", sans-serif;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .button-primary {
      background: #1a73e8;
      color: white;
    }

    .button-primary:hover {
      background: #1557b0;
    }

    .button-secondary {
      background: transparent;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }

    .button-secondary:hover {
      background: #f8f9fa;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
    }

    .modal h3 {
      font-size: 24px;
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #5f6368;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 14px;
      font-family: "Google Sans", sans-serif;
    }

    .form-group input:focus {
      outline: none;
      border-color: #1a73e8;
    }

    .avatar-upload {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .avatar-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f1f3f4;
      color: #5f6368;
      overflow: hidden;
    }

    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-preview .material-symbols-outlined {
      font-size: 80px;
    }

    .avatar-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: #202124;
        color: #e8eaed;
      }

      .section {
        background: #292a2d;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      }

      .profile-item {
        background: #3c4043;
      }

      .profile-item:hover {
        background: #4d5156;
      }

      .profile-item.active {
        background: #1e3a5f;
        border-color: #8ab4f8;
      }

      .icon-button:hover {
        background: rgba(255,255,255,0.1);
      }

      .icon-button .material-symbols-outlined {
        color: #9aa0a6;
      }

      .button-secondary {
        color: #8ab4f8;
        border-color: #5f6368;
      }

      .button-secondary:hover {
        background: #3c4043;
      }

      .modal-content {
        background: #292a2d;
      }

      .form-group input {
        background: #3c4043;
        border-color: #5f6368;
        color: #e8eaed;
      }

      .form-group label {
        color: #9aa0a6;
      }

      .profile-avatar {
        background: #3c4043;
        color: #9aa0a6;
      }

      .avatar-preview {
        background: #3c4043;
        color: #9aa0a6;
      }
    }
    
    .app-toggles {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .app-toggle-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .app-toggle-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .app-toggle-item label {
      margin: 0;
      cursor: pointer;
      font-weight: 400;
      color: #333;
    }
    
    @media (prefers-color-scheme: dark) {
      .app-toggle-item label {
        color: #e8eaed;
      }
    }
  </style>
</head>

<body>
  <h1>Settings</h1>

  <div class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h2 style="margin: 0;">Profiles</h2>
      <button class="button button-primary" onclick="openCreateProfileModal()">
        New Profile
      </button>
    </div>
    
    <div id="profileList" class="profile-list">
      <!-- Profiles will be loaded here -->
    </div>
  </div>

  <!-- Create/Edit Profile Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">New Profile</h3>
      
      <div class="form-group">
        <label>Profile Name</label>
        <input type="text" id="profileName" placeholder="Enter profile name" />
      </div>

      <div class="form-group">
        <label>Profile Picture</label>
        <div class="avatar-upload">
          <div id="avatarPreview" class="avatar-preview">
            <span class="material-symbols-outlined">account_circle</span>
          </div>
          <div class="avatar-actions">
            <button type="button" class="button button-secondary" onclick="selectAvatarImage()">Upload Image</button>
            <button type="button" class="button button-secondary" onclick="removeAvatar()" id="removeAvatarBtn" style="display: none;">Remove</button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>Enabled Apps</label>
        <div class="app-toggles">
          <div class="app-toggle-item">
            <input type="checkbox" id="app-mail" value="mail" checked />
            <label for="app-mail">Gmail</label>
          </div>
          <div class="app-toggle-item">
            <input type="checkbox" id="app-calendar" value="calendar" checked />
            <label for="app-calendar">Calendar</label>
          </div>
          <div class="app-toggle-item">
            <input type="checkbox" id="app-drive" value="drive" checked />
            <label for="app-drive">Drive</label>
          </div>
          <div class="app-toggle-item">
            <input type="checkbox" id="app-gemini" value="gemini" checked />
            <label for="app-gemini">Gemini</label>
          </div>
          <div class="app-toggle-item">
            <input type="checkbox" id="app-keep" value="keep" checked />
            <label for="app-keep">Keep</label>
          </div>
          <div class="app-toggle-item">
            <input type="checkbox" id="app-tasks" value="tasks" checked />
            <label for="app-tasks">Tasks</label>
          </div>
          <div class="app-toggle-item">
            <input type="checkbox" id="app-contacts" value="contacts" checked />
            <label for="app-contacts">Contacts</label>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="button button-secondary" onclick="closeProfileModal()">Cancel</button>
        <button class="button button-primary" onclick="saveProfile()">Save</button>
      </div>
    </div>
  </div>

  <script>
    let profiles = [];
    let activeProfileId = null;
    let selectedAvatarPath = null;
    let editingProfileId = null;
    
    const ALL_APPS = ['mail', 'calendar', 'drive', 'gemini', 'keep', 'tasks', 'contacts'];
    
    function getEnabledApps() {
      return ALL_APPS.filter(app => {
        const checkbox = document.getElementById(`app-${app}`);
        return checkbox && checkbox.checked;
      });
    }
    
    function setEnabledApps(enabledApps) {
      ALL_APPS.forEach(app => {
        const checkbox = document.getElementById(`app-${app}`);
        if (checkbox) {
          checkbox.checked = enabledApps.includes(app);
        }
      });
    }

    // Load profiles on startup
    async function loadProfiles() {
      const data = await window.electronAPI.getProfiles();
      profiles = data.profiles;
      activeProfileId = data.activeProfileId;
      renderProfiles();
    }

    function renderProfiles() {
      const list = document.getElementById('profileList');
      list.innerHTML = '';

      profiles.forEach(profile => {
        const item = document.createElement('div');
        item.className = 'profile-item' + (profile.id === activeProfileId ? ' active' : '');
        item.onclick = () => switchProfile(profile.id);

        const avatar = document.createElement('div');
        avatar.className = 'profile-avatar';
        
        if (profile.avatarPath) {
          avatar.innerHTML = `<img src="file://${profile.avatarPath}" alt="${profile.name}" />`;
        } else {
          avatar.innerHTML = '<span class="material-symbols-outlined">account_circle</span>';
        }

        const info = document.createElement('div');
        info.className = 'profile-info';
        
        const name = document.createElement('div');
        name.className = 'profile-name';
        name.textContent = profile.name;
        if (profile.id === activeProfileId) {
          const badge = document.createElement('span');
          badge.className = 'profile-badge';
          badge.textContent = 'Active';
          name.appendChild(badge);
        }

        info.appendChild(name);

        const actions = document.createElement('div');
        actions.className = 'profile-actions';

        if (!profile.isDefault) {
          const editBtn = document.createElement('button');
          editBtn.className = 'icon-button';
          editBtn.innerHTML = '<span class="material-symbols-outlined">edit</span>';
          editBtn.onclick = (e) => {
            e.stopPropagation();
            openEditProfileModal(profile);
          };

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'icon-button';
          deleteBtn.innerHTML = '<span class="material-symbols-outlined">delete</span>';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteProfile(profile.id);
          };

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);
        }

        item.appendChild(avatar);
        item.appendChild(info);
        item.appendChild(actions);
        list.appendChild(item);
      });
    }

    function openCreateProfileModal() {
      editingProfileId = null;
      document.getElementById('modalTitle').textContent = 'New Profile';
      document.getElementById('profileName').value = '';
      selectedAvatarPath = null;
      updateAvatarPreview(null);
      setEnabledApps(ALL_APPS); // Enable all apps by default
      document.getElementById('profileModal').classList.add('show');
    }

    function openEditProfileModal(profile) {
      editingProfileId = profile.id;
      document.getElementById('modalTitle').textContent = 'Edit Profile';
      document.getElementById('profileName').value = profile.name;
      selectedAvatarPath = profile.avatarPath;
      updateAvatarPreview(profile.avatarPath);
      setEnabledApps(profile.enabledApps || ALL_APPS); // Use profile's enabled apps or default to all
      document.getElementById('profileModal').classList.add('show');
    }

    function closeProfileModal() {
      document.getElementById('profileModal').classList.remove('show');
    }

    async function selectAvatarImage() {
      const filePath = await window.electronAPI.selectAvatar();
      if (filePath) {
        selectedAvatarPath = filePath;
        updateAvatarPreview(filePath);
      }
    }

    function removeAvatar() {
      selectedAvatarPath = null;
      updateAvatarPreview(null);
    }

    function updateAvatarPreview(avatarPath) {
      const preview = document.getElementById('avatarPreview');
      const removeBtn = document.getElementById('removeAvatarBtn');
      
      if (avatarPath) {
        preview.innerHTML = `<img src="file://${avatarPath}" alt="Profile" />`;
        removeBtn.style.display = 'block';
      } else {
        preview.innerHTML = '<span class="material-symbols-outlined">account_circle</span>';
        removeBtn.style.display = 'none';
      }
    }

    async function saveProfile() {
      const name = document.getElementById('profileName').value.trim();
      const enabledApps = getEnabledApps();
      
      if (!name) {
        alert('Please enter a profile name');
        return;
      }
      
      if (enabledApps.length === 0) {
        alert('Please enable at least one app');
        return;
      }

      if (editingProfileId) {
        await window.electronAPI.updateProfile(editingProfileId, { name, avatarPath: selectedAvatarPath, enabledApps });
      } else {
        await window.electronAPI.createProfile({ name, avatarPath: selectedAvatarPath, enabledApps });
      }

      closeProfileModal();
      await loadProfiles();
    }

    async function deleteProfile(id) {
      if (confirm('Are you sure you want to delete this profile?')) {
        await window.electronAPI.deleteProfile(id);
        await loadProfiles();
      }
    }

    async function switchProfile(id) {
      if (id === activeProfileId) return;
      
      await window.electronAPI.switchProfile(id);
      // App will restart with new profile
    }

    // Load profiles when DOM is ready
    loadProfiles();
  </script>
</body>
</html>